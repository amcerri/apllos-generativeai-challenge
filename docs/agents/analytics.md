# Analytics Agent

Covers the planner, executor, and normalizer modules.

## Planner ([app/agents/analytics/planner.py](../../app/agents/analytics/planner.py))

- Purpose: Translate NL requests into safe SQL bounded by an allowlist.
- Features:
  - Prompt engineering with Chain-of-Thought reasoning.
  - Heuristics for preview/aggregate/time series queries.
  - Allowlist validation of identifiers; join validation; schema prefix fixing; alias dot fixes.
  - OpenAI tool calling backend (preferred) with JSON Schema fallback using `llm_client` and prompts.
  - Tool calling reduces token usage compared to JSON Schema mode.
  - Config-driven limits: `default_limit`, `max_limit`, examples count.
- Output: `PlannerPlan` with `sql`, `params`, `reason`, `limit_applied`, `warnings`.

## Executor ([app/agents/analytics/executor.py](../../app/agents/analytics/executor.py))

- Purpose: Execute planner SQL safely.
- Safety:
  - Read-only transaction; `statement_timeout` per query (increased to 120s).
  - Client row caps; GROUP BY heuristic raises cap to avoid truncating categorical sets.
  - Window functions support (LAG, LEAD, ROW_NUMBER, RANK, OVER, PARTITION BY, ORDER BY).
  - EXPLAIN (FORMAT JSON) attached when requested; optional ANALYZE via env.
  - Circuit breaker keyed by SQL hash with backoff after repeated failures.
- Output: `ExecutorResult` with `rows`, counts, latency, warnings, and `meta` (sql, row_cap, timeout, explain, breaker stats).

## Normalizer ([app/agents/analytics/normalize.py](../../app/agents/analytics/normalize.py))

- Purpose: Convert raw rows into PT-BR business narrative with data balancing.
- LLM-First Approach:
  - Decision making: complete data vs. analytical insights based on dataset size and query intent.
  - Configurable threshold (`complete_data_threshold`, default 100 records) for automatic data balancing.
  - Human-like responses with analytical context instead of raw SQL-like outputs.
- Paths:
  - LLM-based: system prompt + examples; produces JSON (`text`, optional structured payload).
  - Fallback: deterministic formatting with insights for small/medium/large datasets.
- Caching:
  - Response cache for similar queries with same SQL and result context.
  - Cache key includes user query, agent name, SQL plan, and result metadata.
  - Reduces redundant LLM calls for repeated or similar analytics queries.
- Extras:
  - Pattern detection (temporal trends, dominance, geographic concentration, category concentration, 1:1 ratios).
  - For large outputs, sampling for LLM then full data appended in response.
  - Dynamic "no results" messages generated by LLM instead of hardcoded responses.

---

**‚Üê [Back to Documentation Index](../README.md)**
